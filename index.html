<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>VAPID æ¨æ’­æ¸¬è©¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
</head>
<body>
  <h1>VAPID æ¨æ’­æ¸¬è©¦</h1>
  <button id="subscribeBtn">å•Ÿç”¨æ¨æ’­</button>
  <script>
    async function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if ('serviceWorker' in navigator) {
        await navigator.serviceWorker.register('./sw.js');
        console.log('âœ… Service Worker å·²è¨»å†Š');
      }

      document.getElementById('subscribeBtn').addEventListener('click', async () => {
        try {
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            alert('æœªæˆæ¬Šé€šçŸ¥');
            return;
          }

          const vapidKeyResp = await fetch('/vapidPublicKey');
          const vapidKey = (await vapidKeyResp.json()).key;
          const appServerKey = await urlBase64ToUint8Array(vapidKey);

          const reg = await navigator.serviceWorker.ready;
          const subscription = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: appServerKey
          });

          console.log('í ½í³¡ è¨‚é–±è³‡è¨Š:', subscription);

          await fetch('/push', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(subscription)
          });

          alert('âœ… è¨‚é–±æˆåŠŸï¼');
        } catch (e) {
          console.error('âŒ æ¨æ’­è¨‚é–±éŒ¯èª¤:', e);
        }
      });
    });
  </script>
</body>
</html>

